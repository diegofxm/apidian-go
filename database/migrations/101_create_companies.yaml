version: "1.0"
name: create_companies
description: "Empresas emisoras de facturas electrónicas"

up:
  - type: create_sequence
    name: companies_id_seq

  - type: create_table
    table: companies
    columns:
      - name: id
        type: BIGINT
        default: "nextval('companies_id_seq')"
        nullable: false
        primary_key: true
      - name: user_id
        type: BIGINT
        nullable: false
      - name: document_type_id
        type: INTEGER
        nullable: false
      - name: nit
        type: VARCHAR(20)
        nullable: false
      - name: dv
        type: VARCHAR(1)
      - name: name
        type: VARCHAR(255)
        nullable: false
      - name: trade_name
        type: VARCHAR(255)
      - name: registration_name
        type: VARCHAR(255)
        nullable: false
      - name: tax_level_code_id
        type: INTEGER
        nullable: false
      - name: tax_type_id
        type: INTEGER
        nullable: true
      - name: type_organization_id
        type: INTEGER
        nullable: false
      - name: type_regime_id
        type: INTEGER
        nullable: false
      - name: industry_codes
        type: VARCHAR(10)[]
      - name: country_id
        type: INTEGER
        nullable: false
      - name: department_id
        type: INTEGER
        nullable: false
      - name: municipality_id
        type: INTEGER
        nullable: false
      - name: address_line
        type: VARCHAR(255)
        nullable: false
      - name: postal_zone
        type: VARCHAR(10)
      - name: phone
        type: VARCHAR(20)
      - name: email
        type: VARCHAR(100)
      - name: website
        type: VARCHAR(255)
      - name: logo_path
        type: VARCHAR(1024)
        nullable: true
      - name: is_active
        type: BOOLEAN
        default: true
        nullable: false
      - name: created_at
        type: TIMESTAMPTZ
        default: NOW()
        nullable: false
      - name: updated_at
        type: TIMESTAMPTZ
        default: NOW()
        nullable: false
    
    foreign_keys:
      - name: fk_companies_user
        column: user_id
        references:
          table: users
          column: id
        on_delete: CASCADE
      - name: fk_companies_document_type
        column: document_type_id
        references:
          table: document_types
          column: id
        on_delete: RESTRICT
      - name: fk_companies_tax_level_code
        column: tax_level_code_id
        references:
          table: tax_level_codes
          column: id
        on_delete: RESTRICT
      - name: fk_companies_tax_type
        column: tax_type_id
        references:
          table: tax_types
          column: id
        on_delete: RESTRICT
      - name: fk_companies_type_organization
        column: type_organization_id
        references:
          table: organization_types
          column: id
        on_delete: RESTRICT
      - name: fk_companies_type_regime
        column: type_regime_id
        references:
          table: regime_types
          column: id
        on_delete: RESTRICT
      - name: fk_companies_country
        column: country_id
        references:
          table: countries
          column: id
        on_delete: RESTRICT
      - name: fk_companies_department
        column: department_id
        references:
          table: departments
          column: id
        on_delete: RESTRICT
      - name: fk_companies_municipality
        column: municipality_id
        references:
          table: municipalities
          column: id
        on_delete: RESTRICT
    
    constraints:
      - type: unique
        name: uq_companies_nit
        columns: [nit]
      - type: check
        name: chk_companies_email
        expression: "email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}$'"
      - type: check
        name: chk_companies_industry_codes
        expression: "array_length(industry_codes, 1) <= 4"
    
    indexes:
      - name: idx_companies_nit
        columns: [nit]
        unique: true
        where: "is_active = true"
      - name: idx_companies_user_id
        columns: [user_id]
      - name: idx_companies_email
        columns: [email]
        where: "email IS NOT NULL"
      - name: idx_companies_tax_type_id
        columns: [tax_type_id]
    
    comment: "Empresas emisoras de facturas electrónicas (AccountingSupplierParty en UBL)"

down:
  - type: drop_table
    table: companies
    cascade: true
  - type: drop_sequence
    name: companies_id_seq
    cascade: true
