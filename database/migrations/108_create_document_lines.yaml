version: "1.0"
name: create_document_lines
description: "Líneas de detalle de documentos electrónicos"

up:
  - type: create_sequence
    name: document_lines_id_seq

  - type: create_table
    table: document_lines
    columns:
      - name: id
        type: BIGINT
        default: "nextval('document_lines_id_seq')"
        nullable: false
        primary_key: true
      - name: document_id
        type: BIGINT
        nullable: false
      - name: product_id
        type: BIGINT
        nullable: false
      - name: line_number
        type: BIGINT
        nullable: false
      - name: description
        type: TEXT
        nullable: false
      - name: quantity
        type: NUMERIC(15,4)
        nullable: false
      - name: unit_price
        type: NUMERIC(15,2)
        nullable: false
      - name: line_total
        type: NUMERIC(15,2)
        nullable: false
      - name: tax_rate
        type: NUMERIC(5,2)
        default: 19.00
      - name: tax_amount
        type: NUMERIC(15,2)
        nullable: false
      - name: brand_name
        type: VARCHAR(100)
        nullable: true
      - name: model_name
        type: VARCHAR(100)
        nullable: true
      - name: standard_item_code
        type: VARCHAR(50)
        nullable: true
      - name: classification_code
        type: VARCHAR(20)
        nullable: true
      - name: created_at
        type: TIMESTAMPTZ
        default: NOW()
        nullable: false
    
    foreign_keys:
      - name: fk_document_lines_document
        column: document_id
        references:
          table: documents
          column: id
        on_delete: CASCADE
      - name: fk_document_lines_product
        column: product_id
        references:
          table: products
          column: id
        on_delete: RESTRICT
    
    constraints:
      - type: unique
        name: uq_document_lines_document_line
        columns: [document_id, line_number]
      - type: check
        name: chk_document_lines_quantity
        expression: "quantity > 0"
      - type: check
        name: chk_document_lines_unit_price
        expression: "unit_price >= 0"
      - type: check
        name: chk_document_lines_line_total
        expression: "line_total >= 0"
      - type: check
        name: chk_document_lines_tax_amount
        expression: "tax_amount >= 0"
      - type: check
        name: chk_document_lines_tax_rate
        expression: "tax_rate >= 0 AND tax_rate <= 100"
    
    indexes:
      - name: idx_document_lines_document_id
        columns: [document_id]
      - name: idx_document_lines_product_id
        columns: [product_id]
      - name: idx_document_lines_created_at
        columns: [created_at]
    
    comment: "Líneas de detalle de documentos electrónicos (InvoiceLine en UBL)"

down:
  - type: drop_table
    table: document_lines
    cascade: true
  - type: drop_sequence
    name: document_lines_id_seq
    cascade: true
